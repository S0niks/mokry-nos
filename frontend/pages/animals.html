<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Животные - Мокрый нос</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
  <div id="navbar"></div>
  <h1>Животные</h1>
  <div id="admin-actions" style="display: none; margin-bottom: 20px;">
    <button onclick="window.location.href='/pages/add-animal.html'">Добавить животное</button>
  </div>
  <div id="filters">
    <input type="text" id="name-filter" placeholder="Поиск по имени" onkeyup="loadAnimals()">
    <select id="species-filter" multiple onchange="loadAnimals()">
      <option value="">Все виды</option>
      <option value="cat">Кошка</option>
      <option value="dog">Собака</option>
    </select>
    <select id="gender-filter" multiple onchange="loadAnimals()">
      <option value="">Все полы</option>
      <option value="male">Мужской</option>
      <option value="female">Женский</option>
    </select>
    <select id="status-filter" multiple onchange="loadAnimals()">
      <option value="">Все статусы</option>
      <option value="в поиске семьи">В поиске семьи</option>
      <option value="нашел семью">Нашел семью</option>
      <option value="на лечение">На лечение</option>
    </select>
    <button onclick="clearFilters()">Сбросить фильтры</button>
  </div>
  <div id="animals-list"></div>
  <script>
    let userRole = null;

    fetch('/components/navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar').innerHTML = data;
        const token = localStorage.getItem('token');
        const authButtons = document.getElementById('auth-buttons');
        if (token) {
          fetch('/api/users/profile', {
            headers: { 'Authorization': `Bearer ${token}` },
          })
            .then(response => response.json())
            .then(user => {
              userRole = user.role;
              if (userRole === 'admin') {
                document.getElementById('admin-actions').style.display = 'block';
              }
              authButtons.innerHTML = `<a href="/pages/profile.html">Профиль</a>`;
              loadAnimals();
            })
            .catch(err => console.error('Ошибка проверки роли:', err));
        } else {
          authButtons.innerHTML = `<a href="/pages/login.html">Вход</a>`;
          loadAnimals();
        }
      })
      .catch(err => console.error('Ошибка загрузки навигации:', err));

    function loadAnimals() {
      const token = localStorage.getItem('token');
      const name = document.getElementById('name-filter').value;
      const species = Array.from(document.getElementById('species-filter').selectedOptions).map(opt => opt.value).filter(v => v);
      const gender = Array.from(document.getElementById('gender-filter').selectedOptions).map(opt => opt.value).filter(v => v);
      const status = Array.from(document.getElementById('status-filter').selectedOptions).map(opt => opt.value).filter(v => v);

      const params = new URLSearchParams();
      if (name) params.append('name', name);
      if (species.length) params.append('species', species.join(','));
      if (gender.length) params.append('gender', gender.join(','));
      if (status.length) params.append('status', status.join(','));

      fetch(`/api/animals?${params.toString()}`, {
        headers: {
          'Authorization': `Bearer ${token || ''}`,
        },
      })
        .then(response => response.json())
        .then(animals => {
          const animalsList = document.getElementById('animals-list');
          animalsList.innerHTML = animals.map(animal => `
            <div class="animal-item">
              <h3>${animal.name.charAt(0).toUpperCase() + animal.name.slice(1)}</h3>
              <p>Вид: ${animal.species === 'cat' ? 'Кошка' : 'Собака'}</p>
              <p>Пол: ${animal.gender === 'male' ? 'Мужской' : 'Женский'}</p>
              <p>Статус: ${animal.status}</p>
              <p>Описание: ${animal.description || 'Нет описания'}</p>
              ${animal.image ? `<img src="${animal.image}" alt="${animal.name}" style="max-width: 200px;">` : ''}
              <div class="admin-buttons" style="display: ${userRole === 'admin' ? 'block' : 'none'};">
                <button onclick="editAnimal(${animal.id})">Редактировать</button>
                <button onclick="deleteAnimal(${animal.id})">Удалить</button>
              </div>
            </div>
          `).join('');
        })
        .catch(err => console.error('Ошибка загрузки животных:', err));
    }

    function clearFilters() {
      document.getElementById('name-filter').value = '';
      document.getElementById('species-filter').selectedIndex = 0;
      document.getElementById('gender-filter').selectedIndex = 0;
      document.getElementById('status-filter').selectedIndex = 0;
      loadAnimals();
    }

    function editAnimal(id) {
      window.location.href = `/pages/edit-animal.html?id=${id}`;
    }

    async function deleteAnimal(id) {
      if (confirm('Вы уверены, что хотите удалить это животное?')) {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`/api/animals/${id}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
            },
          });
          const data = await response.json();
          if (response.ok) {
            alert('Животное удалено!');
            loadAnimals();
          } else {
            alert(data.message || 'Ошибка удаления животного');
          }
        } catch (err) {
          console.error('Ошибка:', err);
          alert('Произошла ошибка. Попробуйте снова.');
        }
      }
    }

    window.onload = () => {
      if (!userRole && localStorage.getItem('token')) {
        fetch('/api/users/profile', {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
        })
          .then(response => response.json())
          .then(user => {
            userRole = user.role;
            if (userRole === 'admin') {
              document.getElementById('admin-actions').style.display = 'block';
            }
            loadAnimals();
          })
          .catch(err => console.error('Ошибка проверки роли:', err));
      } else {
        loadAnimals();
      }
    };
  </script>
</body>
</html>