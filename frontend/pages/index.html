<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мокрый нос - Приют для животных</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
</head>
<body>
  <div id="navbar"></div>

  <h1>Добро пожаловать в «Мокрый нос»</h1>
  <p>Мы - приют для бездомных животных. Здесь вы можете помочь или взять друга!</p>

  <button onclick="window.location.href='/pages/help.html'">Хочу помочь!</button>

  <h2>Новости</h2>
  <div id="admin-news-controls" style="display: none;">
    <button id="add-news-button">Добавить новость</button>
  </div>
  <div id="news-list"></div>

  <!-- Модальное окно для добавления новости -->
  <div id="add-news-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="modal-close">×</span>
      <h2>Добавить новость</h2>
      <form id="add-news-form">
        <label for="add-news-text">Текст новости:</label>
        <textarea id="add-news-text" name="text" required></textarea>
        <label for="add-news-media">Медиа (изображение или видео):</label>
        <input type="file" id="add-news-media" name="media" accept="image/jpeg,image/jpg,image/png,video/mp4">
        <button type="submit">Добавить</button>
      </form>
    </div>
  </div>

  <!-- Модальное окно для редактирования новости -->
  <div id="edit-news-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="modal-close">×</span>
      <h2>Редактировать новость</h2>
      <form id="edit-news-form">
        <input type="hidden" id="edit-news-id" name="id">
        <label for="edit-news-text">Текст новости:</label>
        <textarea id="edit-news-text" name="text" required></textarea>
        <label for="edit-news-media">Медиа (изображение или видео):</label>
        <input type="file" id="edit-news-media" name="media" accept="image/jpeg,image/jpg,image/png,video/mp4">
        <p>Текущее медиа: <span id="edit-current-media"></span></p>
        <button type="submit">Сохранить</button>
      </form>
    </div>
  </div>

  <!-- Модальное окно для удаления новости -->
  <div id="delete-news-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="modal-close">×</span>
      <h2>Удалить новость</h2>
      <p>Вы уверены, что хотите удалить новость "<span id="delete-news-text"></span>"?</p>
      <input type="hidden" id="delete-news-id">
      <button id="confirm-delete-button">Удалить</button>
      <button class="cancel-button">Отмена</button>
    </div>
  </div>

  <script>
    // Загрузка навигации
    fetch('/components/navbar.html')
      .then(response => {
        if (!response.ok) throw new Error('Не удалось загрузить навигацию');
        return response.text();
      })
      .then(data => {
        document.getElementById('navbar').innerHTML = data;
        const token = localStorage.getItem('token');
        const authButtons = document.getElementById('auth-buttons');
        if (token) {
          authButtons.innerHTML = `<a href="/pages/profile.html">Профиль</a>`;
        } else {
          authButtons.innerHTML = `<a href="/pages/login.html">Вход</a>`;
        }
      })
      .catch(err => {
        console.error('Ошибка загрузки навигации:', err);
        document.getElementById('navbar').innerHTML = '<p>Ошибка загрузки навигации</p>';
      });

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      let userRole = null;

      // Проверка роли пользователя
      if (token) {
        fetch('/api/users/profile', {
          headers: { 'Authorization': `Bearer ${token}` }
        })
          .then(response => {
            if (response.status === 401) {
              localStorage.removeItem('token');
              window.location.href = '/pages/login.html';
              throw new Error('Требуется повторный вход');
            }
            if (!response.ok) throw new Error('Не удалось загрузить профиль');
            return response.json();
          })
          .then(data => {
            userRole = data.role;
            if (userRole === 'admin') {
              document.getElementById('admin-news-controls').style.display = 'block';
            }
            loadNews();
          })
          .catch(err => {
            console.error('Ошибка загрузки профиля:', err);
            loadNews();
          });
      } else {
        loadNews();
      }

      // Загрузка новостей
      async function loadNews() {
        try {
          const newsResponse = await fetch('/api/news');
          if (!newsResponse.ok) throw new Error('Ошибка загрузки новостей');
          const news = await newsResponse.json();

          const newsList = document.getElementById('news-list');
          if (news.length === 0) {
            newsList.innerHTML = '<p>Новостей пока нет.</p>';
          } else {
            newsList.innerHTML = news.map(item => {
              return `
                <div class="news-item">
                  <p>${item.text}</p>
                  ${item.media ? (item.media.endsWith('.mp4') ?
                    `<video src="${item.media}" controls style="max-width: 100%;"></video>` :
                    `<img src="${item.media}" alt="Новость" style="max-width: 100%;" onerror="this.style.display='none';">`) : ''}
                  <div class="news-meta">Опубликовано: ${new Date(item.created_at).toLocaleDateString('ru-RU')}</div>
                  ${userRole === 'admin' ? `
                    <div class="news-actions">
                      <button onclick="openEditNewsModal(${item.id})">Редактировать</button>
                      <button onclick="openDeleteNewsModal(${item.id}, '${item.text.replace(/'/g, "\\'").slice(0, 50)}')">Удалить</button>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('');
          }
        } catch (err) {
          console.error('Ошибка загрузки новостей:', err);
          document.getElementById('news-list').innerHTML = '<p>Ошибка загрузки новостей.</p>';
        }
      }

      // Функции для управления модальными окнами
      let activeModal = null;

      function openModal(modalId) {
        if (activeModal) {
          console.log(`Модальное окно ${activeModal.id} уже открыто, игнорируем`);
          return;
        }
        const modal = document.getElementById(modalId);
        if (modal) {
          console.log(`Открытие модального окна: ${modalId}`);
          modal.classList.add('active');
          modal.style.display = 'flex';
          modal.style.visibility = 'visible';
          modal.style.opacity = '1';
          document.body.style.overflow = 'hidden';
          activeModal = modal;
        } else {
          console.error(`Модальное окно с ID ${modalId} не найдено`);
        }
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          console.log(`Закрытие модального окна: ${modalId}`);
          modal.classList.remove('active');
          modal.style.display = 'none';
          modal.style.visibility = 'hidden';
          modal.style.opacity = '0';
          document.body.style.overflow = '';
          activeModal = null;
        } else {
          console.error(`Модальное окно с ID ${modalId} не найдено`);
        }
      }

      // Открытие модального окна для добавления
      document.getElementById('add-news-button')?.addEventListener('click', () => {
        openModal('add-news-modal');
        document.getElementById('add-news-form').reset();
      });

      // Открытие модального окна для редактирования
      window.openEditNewsModal = async function(newsId) {
        try {
          const response = await fetch(`/api/news/${newsId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/pages/login.html';
            throw new Error('Требуется повторный вход');
          }
          if (!response.ok) throw new Error('Ошибка загрузки новости');
          const news = await response.json();

          document.getElementById('edit-news-id').value = news.id;
          document.getElementById('edit-news-text').value = news.text;
          document.getElementById('edit-current-media').textContent = news.media ? news.media : 'Отсутствует';
          openModal('edit-news-modal');
        } catch (err) {
          console.error('Ошибка:', err);
          alert('Не удалось загрузить данные новости');
        }
      };

      // Открытие модального окна для удаления
      window.openDeleteNewsModal = function(newsId, newsText) {
        document.getElementById('delete-news-id').value = newsId;
        document.getElementById('delete-news-text').textContent = newsText;
        openModal('delete-news-modal');
      };

      // Закрытие модальных окон
      document.querySelectorAll('.modal-close, .cancel-button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.modal').forEach(modal => {
            closeModal(modal.id);
          });
        });
      });

      // Закрытие модального окна при клике вне контента
      window.addEventListener('click', (event) => {
        if (event.target.classList.contains('modal')) {
          closeModal(event.target.id);
        }
      });

      // Добавление новости
      document.getElementById('add-news-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        formData.append('text', document.getElementById('add-news-text').value);
        const mediaFile = document.getElementById('add-news-media').files[0];
        if (mediaFile) {
          formData.append('media', mediaFile);
        }

        try {
          const response = await fetch('/api/news', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
          });
          if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/pages/login.html';
            throw new Error('Требуется повторный вход');
          }
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Ошибка добавления новости');
          }
          const data = await response.json();
          alert('Новость добавлена!');
          closeModal('add-news-modal');
          loadNews();
        } catch (err) {
          console.error('Ошибка:', err);
          alert(err.message || 'Произошла ошибка при добавлении новости');
        }
      });

      // Редактирование новости
      document.getElementById('edit-news-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newsId = document.getElementById('edit-news-id').value;
        const formData = new FormData();
        formData.append('text', document.getElementById('edit-news-text').value);
        const mediaFile = document.getElementById('edit-news-media').files[0];
        if (mediaFile) {
          formData.append('media', mediaFile);
        }

        try {
          const response = await fetch(`/api/news/${newsId}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
          });
          if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/pages/login.html';
            throw new Error('Требуется повторный вход');
          }
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Ошибка редактирования новости');
          }
          const data = await response.json();
          alert(data.message || 'Новость обновлена!');
          closeModal('edit-news-modal');
          loadNews();
        } catch (err) {
          console.error('Ошибка:', err);
          alert(err.message || 'Произошла ошибка при редактировании новости');
        }
      });

      // Удаление новости
      document.getElementById('confirm-delete-button').addEventListener('click', async () => {
        const newsId = document.getElementById('delete-news-id').value;
        try {
          const response = await fetch(`/api/news/${newsId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (response.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/pages/login.html';
            throw new Error('Требуется повторный вход');
          }
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Ошибка удаления новости');
          }
          const data = await response.json();
          alert(data.message || 'Новость удалена!');
          closeModal('delete-news-modal');
          loadNews();
        } catch (err) {
          console.error('Ошибка:', err);
          alert(err.message || 'Произошла ошибка при удалении новости');
        }
      });
    });
  </script>
</body>
</html>